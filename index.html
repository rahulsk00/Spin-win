<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User App - Invite & Earn</title>
    
    <!-- RAZORPAY SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        :root {
            --primary-color: #4F46E5;
            --secondary-color: #818CF8;
            --accent-color: #F59E0B;
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-color: #1F2937;
            --text-light: #6B7280;
            --success-color: #10B981;
            --nav-height: 70px;
            --whatsapp-color: #25D366;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }

        /* Auth Screen */
        #authScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px;
        }
        .auth-card {
            background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
        }
        .auth-title { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; font-weight: bold; }
        .switch-auth { margin-top: 15px; font-size: 0.9rem; color: var(--primary-color); cursor: pointer; text-decoration: underline; }

        /* Main App */
        #mainApp { display: none; height: 100vh; overflow-y: auto; padding-bottom: var(--nav-height); }
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 20px; padding-bottom: 40px;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 10px; }
        .logout-btn, .legal-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; text-decoration: none; }
        .logout-btn:hover, .legal-btn:hover { background: rgba(255,255,255,0.4); }
        
        .balance-card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 15px; border-radius: 15px; text-align: center; margin-top: 10px; }
        .balance-amount { font-size: 2rem; font-weight: bold; color: #FFD700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        
        /* Referrer Display */
        .referrer-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: #E0E7FF; margin-top: 5px; display: none; }
        
        main { padding: 20px; max-width: 600px; margin: 0 auto; margin-top: -30px; }
        section { display: none; animation: fadeIn 0.3s ease-in-out; }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; background: var(--primary-color); color: white; transition: 0.3s; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn-premium { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; width: auto; padding: 8px 20px; font-size: 0.9rem; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3); }
        .btn-legal-active { background: white; color: var(--primary-color); }
        
        .input-group { margin-bottom: 12px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-light); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none; }

        /* Membership */
        .membership-card { background: #fffbeb; border: 1px solid #fbbf24; display: flex; justify-content: space-between; align-items: center; padding: 15px; transition: 0.3s; }
        .membership-card.locked { background: #f0fdf4; border: 1px solid #10B981; }

        /* Scratch Card */
        .scratch-container { position: relative; width: 100%; height: 200px; margin: 0 auto; user-select: none; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; }
        .scratch-result { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #FF9A9E 0%, #FECFEF 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1; padding: 20px; text-align: center; }
        #scratchCover { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #6B7280, #374151); z-index: 2; display: flex; flex-direction: column; justify-content: center; align-items: center; border: none; cursor: pointer; transition: transform 0.1s; color: white; }
        #scratchCover:active { transform: scale(0.98); }
        .scratch-icon { font-size: 3rem; margin-bottom: 10px; pointer-events: none; }
        .scratch-text { font-weight: bold; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }

        /* Invite & Rules */
        .invite-link-box { background: #E0E7FF; padding: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border: 1px solid #C7D2FE; }
        .invite-link-text { font-size: 0.85rem; color: var(--primary-color); font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; flex: 1; }
        .share-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .share-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: white; }
        .share-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .btn-copy { background: var(--primary-color); }
        .btn-system { background: var(--accent-color); }
        .btn-whatsapp { background: var(--whatsapp-color); }
        .rules-box { background: #FFFBEB; border: 1px solid #FCD34D; border-radius: 10px; padding: 15px; margin-top: 20px; }
        .rules-title { font-weight: bold; color: #92400E; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .rules-list { list-style: none; padding-left: 0; }
        .rules-list li { font-size: 0.85rem; color: #78350F; margin-bottom: 6px; padding-left: 20px; position: relative; }
        .rules-list li::before { content: "‚úì"; position: absolute; left: 0; color: #F59E0B; font-weight: bold; }

        /* Invited List */
        .invited-list { margin-top: 15px; }
        .invited-item { display: flex; align-items: center; padding: 10px 0; border-bottom:1px solid #eee; }
        .invited-item:last-child { border-bottom: none; }
        .invited-avatar { width: 35px; height: 35px; background: #e0e7ff; color: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; font-size: 0.8rem; }
        .invited-status { margin-left: auto; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #DEF7EC; color: #03543F; }

        /* Transaction List */
        .transaction-list { margin-top: 20px; }
        .transaction-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .amount.plus { color: var(--success-color); }
        .amount.minus { color: #EF4444; }
        .req-status { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; background: #eee; margin-left: 5px; }
        .req-status.pending { background: #FEF3C7; color: #D97706; }
        .req-status.approved { background: #D1FAE5; color: #059669; }
        .req-status.rejected { background: #FEE2E2; color: #DC2626; }

        /* Leaderboard */
        .lb-toggle { display: flex; background: #e5e7eb; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .lb-btn { flex: 1; padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #6b7280; transition: 0.3s; }
        .lb-btn.active { background: white; color: var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .lb-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f3f4f6; background: white; }
        .lb-rank { width: 30px; font-weight: bold; color: #9ca3af; font-size: 1.1rem; }
        .lb-rank.rank-1 { color: var(--gold); font-size: 1.4rem; }
        .lb-rank.rank-2 { color: var(--silver); font-size: 1.3rem; }
        .lb-rank.rank-3 { color: var(--bronze); font-size: 1.3rem; }
        .lb-avatar { width: 40px; height: 40px; background: #dbeafe; color: #1e40af; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        .lb-info { flex: 1; }
        .lb-name { font-weight: 600; font-size: 0.95rem; }
        .lb-earning { font-size: 0.85rem; color: var(--success-color); font-weight: bold; }
        .lb-item.me { background: #eff6ff; border-left: 4px solid var(--primary-color); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(31, 41, 55, 0.95); color: white; padding: 12px 24px; border-radius: 50px; z-index: 3000; display: none; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        
        /* Legal Modal Style */
        .legal-modal-content { width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column; }
        .legal-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .legal-tab-btn { flex: 1; padding: 10px; background: #f3f4f6; border: none; border-radius: 5px; font-weight: bold; color: #666; cursor: pointer; }
        .legal-tab-btn.active { background: var(--primary-color); color: white; }
        .legal-text-body { flex: 1; overflow-y: auto; padding-right: 10px; text-align: left; line-height: 1.6; color: #333; font-size: 0.9rem; }
        .legal-text-body h1 { color: var(--primary-color); font-size: 1.5rem; margin-bottom: 10px; }
        .legal-text-body h2 { font-size: 1.2rem; color: #1F2937; margin-top: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .legal-text-body ul { padding-left: 20px; }
        .uppercase { text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Message here</div>

    <!-- AUTH SCREEN -->
    <div id="authScreen">
        <div class="auth-card" id="loginCard">
            <h2 class="auth-title">Welcome Back</h2>
            <div class="input-group"><input type="email" id="loginEmail" class="input-field" placeholder="Email Address"></div>
            <div class="input-group"><input type="password" id="loginPass" class="input-field" placeholder="Password"></div>
            <button class="btn" onclick="handleLogin()">Login</button>
            <div class="switch-auth" onclick="toggleAuth('register')">Don't have an account? Register</div>
        </div>
        <div class="auth-card" id="registerCard" style="display: none;">
            <h2 class="auth-title">Create Account</h2>
            <div class="input-group"><input type="text" id="regName" class="input-field" placeholder="Full Name"></div>
            <div class="input-group"><input type="email" id="regEmail" class="input-field" placeholder="Email Address"></div>
            <div class="input-group"><input type="password" id="regPass" class="input-field" placeholder="Password"></div>
            <button class="btn" onclick="handleRegister()">Register</button>
            <div class="switch-auth" onclick="toggleAuth('login')">Already have an account? Login</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <header>
            <div class="header-top">
                <div class="user-info">
                    <h2 id="headerUserName">User</h2>
                    <span style="font-size: 0.8rem; opacity: 0.8;">ID: <span id="headerUserId">...</span></span>
                    <div id="referrerInfo" class="referrer-badge">Referred by: <span id="headerReferrerId">...</span></div>
                </div>
                <div class="header-actions">
                    <button class="legal-btn" onclick="openLegal()">Legal</button>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
            <div class="balance-card">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount">‚Çπ <span id="headerBalance">0.00</span></div>
            </div>
        </header>

        <main>
            <!-- Home Section -->
            <section id="home" class="active">
                <div class="card">
                    <h3 style="margin-bottom:10px; color:var(--primary-color);">‚ö° Daily Scratch Card</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Tap once to reveal prize!</p>
                    
                    <div class="scratch-container" id="scratchContainer">
                        <div class="scratch-result">
                            <div style="font-size:1.5rem; font-weight:bold; margin-bottom:5px;">üéâ</div>
                            <span id="scratchResultText" style="font-size: 1.2rem;">...</span>
                        </div>
                        <button id="scratchCover" type="button" onclick="revealPrize(event)">
                            <div class="scratch-icon">üëÜ</div>
                            <div class="scratch-text">Tap to Scratch</div>
                        </button>
                    </div>
                </div>

                <!-- Membership Card -->
                <div class="card membership-card" id="membershipCard">
                    <div>
                        <h4 id="memTitle" style="color:#92400e; margin-bottom:4px;">üíé Premium Membership</h4>
                        <p id="memDesc" style="font-size:0.85rem; color:#b45309;">Lifetime Access | ‚Çπ99</p>
                    </div>
                    <button id="memBtn" class="btn btn-premium" onclick="buyMembership()">Buy Now</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--primary-color);">Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn btn-outline" onclick="navTo('wallet')">üí∏ Withdraw</button>
                        <button class="btn btn-outline" onclick="navTo('invite')">ü§ù Invite</button>
                    </div>
                </div>
            </section>

            <!-- Invite Section -->
            <section id="invite">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--primary-color);">Invite & Earn</h3>
                    <p style="font-size: 0.9rem; color: #555; margin-bottom: 15px;">Share your link. Earn ‚Çπ90 when a friend buys membership.</p>
                    
                    <div class="invite-link-box">
                        <span class="invite-link-text" id="refLink">https://earnapp.com/join/user123</span>
                    </div>

                    <div class="share-actions">
                        <button class="share-btn btn-copy" onclick="copyLink()">
                            <span class="share-icon">üìã</span>
                            <span>Copy</span>
                        </button>
                        <button class="share-btn btn-system" onclick="nativeShare()">
                            <span class="share-icon">üîó</span>
                            <span>Share</span>
                        </button>
                        <button class="share-btn btn-whatsapp" onclick="shareWhatsapp()">
                            <span class="share-icon">üí¨</span>
                            <span>WhatsApp</span>
                        </button>
                    </div>

                    <div class="rules-box">
                        <div class="rules-title">üìú Invite Rules</div>
                        <ul class="rules-list">
                            <li>Share your unique referral link with friends.</li>
                            <li>Your friend must register using that link.</li>
                            <li>Reward is given only when your friend buys Premium Membership.</li>
                            <li>You will receive ‚Çπ90 instantly upon their purchase.</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h4 id="inviteListTitle" style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">Invited Routes (0)</h4>
                    <div class="invited-list" id="invitedList">
                        <p style="text-align:center; color:#999; font-size:0.9rem; padding:10px;">No invites yet</p>
                    </div>
                </div>
            </section>

            <!-- Wallet Section -->
            <section id="wallet">
                <div class="card" style="text-align: center; padding: 30px 20px;">
                    <h3>Wallet Balance</h3>
                    <h1 style="font-size: 2.5rem; color: var(--primary-color); margin: 10px 0;">‚Çπ <span id="walletBalance">0.00</span></h1>
                    <button class="btn" style="background: var(--success-color);" onclick="openWithdrawModal()">Withdraw Money</button>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--primary-color);">Transaction History</h3>
                    <div id="transactionList">
                        <p style="text-align: center; color: #999; padding: 10px;">No transactions yet</p>
                    </div>
                </div>
            </section>

            <!-- Ranking Section -->
            <section id="ranking">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--primary-color);">üèÜ Leaderboard</h3>
                    
                    <div class="lb-toggle">
                        <div class="lb-btn active" id="btnDaily" onclick="switchLeaderboard('daily')">Daily</div>
                        <div class="lb-btn" id="btnMonthly" onclick="switchLeaderboard('monthly')">Monthly</div>
                    </div>

                    <div id="leaderboardList">
                        <!-- Content Generated by JS -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navTo('home')" id="nav-home"><span class="nav-icon">üè†</span><span>Home</span></div>
            <div class="nav-item" onclick="navTo('invite')" id="nav-invite"><span class="nav-icon">üîó</span><span>Invite</span></div>
            <div class="nav-item" onclick="navTo('wallet')" id="nav-wallet"><span class="nav-icon">üí∞</span><span>Wallet</span></div>
            <div class="nav-item" onclick="navTo('ranking')" id="nav-ranking"><span class="nav-icon">üèÜ</span><span>Ranking</span></div>
        </nav>
    </div>

    <!-- Legal Modal -->
    <div class="modal-overlay" id="legalModal">
        <div class="modal legal-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Legal Information</h3>
                <button class="btn btn-outline" style="width:auto; padding: 5px 10px;" onclick="closeModals()">Close</button>
            </div>
            <div class="legal-tabs">
                <button class="legal-tab-btn active" id="btnTerms" onclick="showLegal('terms')">Terms of Service</button>
                <button class="legal-tab-btn" id="btnPrivacy" onclick="showLegal('privacy')">Privacy Policy</button>
            </div>
            <div class="legal-text-body" id="legalContent">
                <!-- Content Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <h3 style="margin-bottom:15px;">Bank Transfer Request</h3>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Balance will be deducted immediately upon request.</p>
            <div class="input-group"><label>Amount (‚Çπ)</label><input type="number" id="wAmount" class="input-field"></div>
            <div class="input-group"><label>Account Holder Name</label><input type="text" id="wName" class="input-field"></div>
            <div class="input-group"><label>Bank Name</label><input type="text" id="wBank" class="input-field"></div>
            <div class="input-group"><label>Account Number</label><input type="text" id="wAcc" class="input-field"></div>
            <div class="input-group"><label>IFSC Code</label><input type="text" id="wIfsc" class="input-field uppercase"></div>
            <div class="input-group"><label>Mobile Number</label><input type="tel" id="wMobile" class="input-field"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="processWithdraw()">Submit Request</button>
                <button class="btn btn-outline" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, query, collection, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
          apiKey: "AIzaSyDZfUrq0oLhaNH4BT5eI8TJzTxZaHQnEEw",
          authDomain: "usdt-33005.firebaseapp.com",
          projectId: "usdt-33005",
          storageBucket: "usdt-33005.appspot.com",
          messagingSenderId: "804332729768",
          appId: "1:804332729768:web:3d34009e4c5cc1005d599d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // === GLOBAL STATE ===
        let currentUser = null;
        let userData = null;
        let leaderboardType = 'daily';
        let unsubscribe = null;
        let referrerId = null;

        // === LEGAL CONTENT DATA ===
        const legalDocs = {
            terms: `
                <h1>Terms of Service</h1>
                <p><strong>Last Updated:</strong> October 2023</p>
                <p>Welcome to Spin Win (the "App"). By accessing or using our App, you agree to be bound by these Terms. If you disagree with any part of these terms, you must not access our App.</p>
                
                <h2>1. Description of Service</h2>
                <p>Spin Win is an "Invite & Earn" mobile application platform that allows users to:</p>
                <ul>
                    <li>Participate in daily scratch cards to win virtual currency.</li>
                    <li>Purchase a Premium Membership to unlock lifetime features.</li>
                    <li>Invite friends to the platform and earn referral bonuses.</li>
                    <li>Request withdrawal of earned virtual currency to bank accounts.</li>
                </ul>

                <h2>2. Premium Membership</h2>
                <p>We offer a Premium Membership for a one-time fee (INR ‚Çπ99).</p>
                <ul>
                    <li>The fee is non-refundable once membership is activated.</li>
                    <li>Premium status is linked to user account.</li>
                    <li>We reserve the right to revoke premium status if a user violates our Terms.</li>
                </ul>

                <h2>3. Financial Transactions & Withdrawals</h2>
                <ul>
                    <li><strong>Earnings:</strong> Virtual currency earned via scratch cards or referrals has no cash value until a withdrawal request is approved.</li>
                    <li><strong>Withdrawal Requests:</strong> Users can request withdrawals subject to minimum balance limits.</li>
                    <li><strong>Approval Authority:</strong> All withdrawal requests are subject to manual review by Admin. We reserve the right to approve or reject any request without prior notice. Rejected amounts will be refunded to the user's wallet balance.</li>
                    <li><strong>Processing Time:</strong> Withdrawals may take 3 to 7 business days to process depending on banking hours.</li>
                    <li>Users must provide accurate banking details. We are not responsible for lost funds due to incorrect account information provided by the user.</li>
                </ul>

                <h2>4. Referral System</h2>
                <p>Users may invite others to the App using a unique referral link.</p>
                <ul>
                    <li>A referral bonus (‚Çπ90) is credited only when the referred user successfully purchases a Premium Membership.</li>
                    <li>Self-referral is strictly prohibited. Users found using fake accounts or abusing the referral system will have their accounts banned and earnings forfeited.</li>
                </ul>

                <h2>5. User Conduct</h2>
                <ul>
                    <li>Users agree not to use the App for any illegal or unauthorized purpose.</li>
                    <li>Users must not use bots, scripts, or automated methods to manipulate game mechanics (Scratch Cards).</li>
                    <li>Only one account per person is allowed. Multiple accounts will lead to a permanent ban.</li>
                    <li>Any attempt to hack, exploit, or damage the App will result in immediate legal action.</li>
                </ul>

                <h2>6. Limitation of Liability</h2>
                <p>Spin Win and its affiliates shall not be liable for any indirect, incidental, special, consequential or punitive damages, resulting from your access or use of the App.</p>
            `,
            privacy: `
                <h1>Privacy Policy</h1>
                <p><strong>Last Updated:</strong> October 2023</p>
                <p>Spin Win ("we," "us," or "our") respects your privacy and is committed to protecting your personal information. This privacy policy will inform you how we use your data.</p>

                <h2>1. Information We Collect</h2>
                <p>We collect information you provide directly when using the App:</p>
                <ul>
                    <li><strong>Personal Information:</strong> Name, Email address (for Authentication).</li>
                    <li><strong>Payment Information:</strong> We use Razorpay to process payments. We do not store your credit/debit card details. Razorpay is PCI DSS compliant and adheres to the highest level of security.</li>
                    <li><strong>Bank Details:</strong> Account Number, IFSC Code, Bank Name (for processing withdrawals). These details are stored securely in our database (Firebase).</li>
                    <li><strong>Usage Data:</strong> Earnings, scratch card history, referral list.</li>
                </ul>

                <h2>2. How We Use Your Information</h2>
                <ul>
                    <li>To create and manage your user account.</li>
                    <li>To process Premium Membership payments via Razorpay.</li>
                    <li>To process withdrawal requests and transfer money to your bank account.</li>
                    <li>To credit referral bonuses to your wallet.</li>
                    <li>To monitor for fraud, illegal activity, or policy violations.</li>
                </ul>

                <h2>3. Data Storage & Security</h2>
                <p>We take reasonable measures to protect your data:</p>
                <ul>
                    <li><strong>Firebase (Google Cloud):</strong> User data (excluding financial card data) is stored in Firebase. Google Cloud provides industry-leading encryption and security.</li>
                    <li><strong>Payment Data:</strong> All financial transactions are processed securely via Razorpay payment gateway.</li>
                    <li>However, no method of transmission over the Internet, or method of electronic storage is 100% secure.</li>
                </ul>

                <h2>4. Third-Party Services</h2>
                <p>We use third-party services to help operate our App:</p>
                <ul>
                    <li><strong>Firebase:</strong> For user authentication and real-time database.</li>
                    <li><strong>Razorpay:</strong> For processing payments securely.</li>
                </ul>

                <h2>5. User Rights</h2>
                <ul>
                    <li><strong>Access:</strong> You can access and update your profile within the App.</li>
                    <li><strong>Deletion:</strong> If you wish to delete your account and all personal data, please contact us at <strong>rahul615@gmail.com</strong>.</li>
                    <li>Upon deletion, your wallet balance will be forfeited unless a valid withdrawal request is pending.</li>
                </ul>
            `
        };

        // === CHECK REFERRER ON LOAD ===
        function checkReferrer() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref');
            if (ref) {
                localStorage.setItem('ref_id', ref);
                referrerId = ref;
                console.log("Referrer ID found:", ref);
            } else {
                const storedRef = localStorage.getItem('ref_id');
                if (storedRef) {
                    referrerId = storedRef;
                }
            }
        }
        checkReferrer();

        // === AUTH ===
        window.toggleAuth = (screen) => {
            if(screen === 'register') {
                document.getElementById('loginCard').style.display = 'none';
                document.getElementById('registerCard').style.display = 'block';
            } else {
                document.getElementById('loginCard').style.display = 'block';
                document.getElementById('registerCard').style.display = 'none';
            }
        };

        window.handleRegister = async () => {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value.trim();
            if(!name || !email || !pass) return showToast('Please fill all fields');

            try {
                // Create Auth User
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const uid = userCredential.user.uid;

                // Prepare User Data
                const userData = {
                    id: uid,
                    name: name,
                    email: email,
                    password: pass,
                    balance: 0,
                    lastScratchDate: null,
                    transactions: [],
                    isPremium: false,
                    invitedUsers: [],
                    withdrawRequests: [],
                    todayEarnings: 0,
                    monthEarnings: 0,
                    lastEarningResetDate: new Date().toDateString(),
                    lastMonthResetDate: (new Date().getMonth() + 1) + "/" + new Date().getFullYear(),
                    createdAt: new Date().toISOString()
                };

                // CREATE USER IN FIRESTORE
                const newUserRef = doc(db, "users", uid);
                await setDoc(newUserRef, userData);

                // === REFERRAL LOGIC ===
                if (window.referrerId) {
                    userData.referredBy = window.referrerId;
                    const referrerRef = doc(db, "users", window.referrerId);
                    const referrerSnap = await getDoc(referrerRef);
                    
                    if (referrerSnap.exists()) {
                        const referrerData = referrerSnap.data();
                        const invitedList = referrerData.invitedUsers || [];
                        invitedList.push({ uid: uid, name: name, date: new Date().toLocaleDateString() });
                        await updateDoc(referrerRef, { invitedUsers: invitedList });
                        localStorage.removeItem('ref_id');
                    }
                }

                showToast('Registered! Please login.');
                toggleAuth('login');
            } catch (error) {
                showToast(error.message);
            }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value.trim();

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                showToast('Invalid email or password');
            }
        };

        window.handleLogout = () => {
            signOut(auth);
            window.referrerId = null;
            localStorage.removeItem('ref_id');
        };

        // === AUTH LISTENER ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                window.currentUser = user;
                listenToUserData(user.uid);
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                window.currentUser = null;
                window.userData = null;
                if(unsubscribe) unsubscribe(); 
            }
        });

        // Listen to Real-time Data for Current User
        function listenToUserData(uid) {
            const userDocRef = doc(db, "users", uid);
            
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    window.userData = doc.data();
                    initApp();
                }
            });
        }

        // === APP LOGIC ===
        function initApp() {
            if(!window.userData) return;
            const data = window.userData;
            
            // Ensure fields exist
            if(!data.todayEarnings) data.todayEarnings = 0;
            if(!data.monthEarnings) data.monthEarnings = 0;
            if(!data.withdrawRequests) data.withdrawRequests = [];
            if(!data.invitedUsers) data.invitedUsers = [];

            checkDateResets(data);
            
            document.getElementById('headerUserName').innerText = data.name;
            document.getElementById('headerUserId').innerText = data.id;
            document.getElementById('refLink').innerText = window.location.origin + "/join/" + data.id;
            
            // Show Referrer Badge
            const referrerInfoDiv = document.getElementById('referrerInfo');
            const referrerIdSpan = document.getElementById('headerReferrerId');
            if (data.referredBy) {
                referrerInfoDiv.style.display = 'block';
                referrerIdSpan.innerText = data.referredBy;
            } else {
                referrerInfoDiv.style.display = 'none';
            }

            updateUI(data);
            resetScratchCardUI(data);
            renderInvitedList(data);
        }

        function checkDateResets(data) {
            const now = new Date();
            const todayStr = now.toDateString();
            const monthStr = (now.getMonth() + 1) + "/" + now.getFullYear();
            let needsUpdate = false;

            if (data.lastEarningResetDate !== todayStr) {
                window.userData.todayEarnings = 0;
                window.userData.lastEarningResetDate = todayStr;
                needsUpdate = true;
            }
            if (data.lastMonthResetDate !== monthStr) {
                window.userData.monthEarnings = 0;
                window.userData.lastMonthResetDate = monthStr;
                needsUpdate = true;
            }

            if(needsUpdate) saveToDB(window.userData);
        }

        async function saveToDB(dataObj) {
            if(!window.currentUser) return;
            const uid = window.currentUser.uid;
            try {
                await updateDoc(doc(db, "users", uid), dataObj);
            } catch (e) {
                console.error("Save Error:", e);
                showToast("Error saving data");
            }
        }

        function updateUI(data) {
            document.getElementById('headerBalance').innerText = data.balance.toFixed(2);
            document.getElementById('walletBalance').innerText = data.balance.toFixed(2);

            // Membership UI
            const card = document.getElementById('membershipCard');
            const title = document.getElementById('memTitle');
            const btn = document.getElementById('memBtn');
            if (data.isPremium) {
                card.classList.add('locked');
                title.innerText = "üîí Premium Unlocked";
                btn.innerHTML = "Purchased";
                btn.disabled = true;
                btn.style.background = '#9ca3af';
            } else {
                card.classList.remove('locked');
                title.innerText = "üíé Premium Membership";
                btn.innerHTML = "Buy Now";
                btn.disabled = false;
                btn.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
            }

            // Transaction List
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            const allHistory = [
                ...(data.transactions || []).map(t => ({...t, type: t.type || 'info'})),
                ...(data.withdrawRequests || []).map(r => ({
                    desc: 'Withdraw Request', 
                    amount: r.amount, 
                    type: 'debit', 
                    isReq: true, 
                    status: r.status,
                    id: r.id
                }))
            ].sort((a,b) => b.id - a.id);

            if(allHistory.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 10px;">No transactions yet</p>';
            } else {
                allHistory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'transaction-item';
                    let statusBadge = item.isReq ? `<span class="req-status ${item.status}">${item.status}</span>` : '';
                    div.innerHTML = `
                        <span>${item.desc} ${statusBadge}</span>
                        <span style="color:${item.type==='credit'?'green':'red'}">${item.type==='credit'?'+':'-'}‚Çπ${item.amount.toFixed(2)}</span>
                    `;
                    list.appendChild(div);
                });
            }
        }

        window.navTo = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');

            if(id === 'ranking') loadLeaderboard();
        };

        // === SCRATCH LOGIC ===
        function resetScratchCardUI(data) {
            const cover = document.getElementById('scratchCover');
            const resultText = document.getElementById('scratchResultText');
            const today = new Date().toDateString();
            if (data.lastScratchDate === today) {
                cover.style.display = 'none';
                resultText.innerText = "Come back tomorrow!";
            } else {
                cover.style.display = 'flex';
                resultText.innerText = "...";
            }
        }

        window.revealPrize = (e) => {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            if(!window.userData) return;

            const cover = document.getElementById('scratchCover');
            const resultText = document.getElementById('scratchResultText');
            const today = new Date().toDateString();
            if (cover.style.display === 'none') return;

            let prize = parseFloat(Math.random().toFixed(2));
            let msg = prize > 0 ? `‚Çπ ${prize}` : "Better Luck Next Time";
            
            cover.style.display = 'none';
            resultText.innerText = msg;

            // Update Data
            window.userData.lastScratchDate = today;
            window.userData.balance += prize;
            window.userData.todayEarnings += prize;
            window.userData.monthEarnings += prize;

            const newTx = {type:'credit', amount:prize, desc:'Scratch Card Win', id: Date.now()};
            if(!window.userData.transactions) window.userData.transactions = [];
            window.userData.transactions.push(newTx);

            saveToDB(window.userData);
            if(prize > 0) showToast(`You won ‚Çπ${prize}!`);
            else showToast('Better luck next time!');
        };

        // === MEMBERSHIP (RAZORPAY) ===
        window.buyMembership = () => {
            if(window.userData.isPremium) return showToast('Already Premium');
            if(!window.currentUser) return showToast('Please login first');

            var options = {
                "key": "rzp_test_RxIVm926W7KfMm",
                "amount": "9900",
                "currency": "INR",
                "name": "Premium Membership",
                "description": "Lifetime access for Invite & Earn App",
                "image": "https://cdn-icons-png.flaticon.com/512/2952.png",
                
                // === IMPORTANT: LINKS FOR RAZORPAY POLICY ===
                "notes": {
                    "terms": window.location.origin + "/terms",
                    "privacy": window.location.origin + "/privacy"
                },
                // ==========================================

                "handler": async function (response){
                    // Payment Success Handler
                    console.log(response);
                    
                    // 1. Firebase Update
                    window.userData.isPremium = true;
                    await saveToDB(window.userData);

                    // 2. REFERRAL BONUS LOGIC
                    const storedRef = localStorage.getItem('ref_id');
                    
                    if (storedRef) {
                        const referrerRef = doc(db, "users", storedRef);
                        const referrerSnap = await getDoc(referrerRef);
                        
                        if (referrerSnap.exists()) {
                            const referrerData = referrerSnap.data();
                            const newBalance = (referrerData.balance || 0) + 90;
                            const bonusTx = {type: 'credit', amount: 90, desc: 'Referral Bonus', id: Date.now()};
                            const transactions = referrerData.transactions || [];
                            transactions.push(bonusTx);

                            await updateDoc(referrerRef, {
                                balance: newBalance,
                                transactions: transactions
                            });

                            localStorage.removeItem('ref_id');
                            console.log("Bonus added to referrer!");
                        }
                    }

                    showToast('Membership Activated!');
                },
                "modal": {
                    "ondismiss": function(){
                        console.log('Checkout form closed');
                    }
                }
            };

            var rzp = new Razorpay(options);
            rzp.open();
        };

        // === WITHDRAW ===
        window.openWithdrawModal = () => {
            if(window.userData.balance <= 0) return showToast('Insufficient balance');
            document.getElementById('withdrawModal').style.display = 'flex';
        };

        window.processWithdraw = async () => {
            if(!window.userData) return;
            
            const amt = parseFloat(document.getElementById('wAmount').value);
            const name = document.getElementById('wName').value;
            const bank = document.getElementById('wBank').value;
            const acc = document.getElementById('wAcc').value;
            const ifsc = document.getElementById('wIfsc').value;
            const mobile = document.getElementById('wMobile').value;

            if(!amt || amt <= 0 || !name || !acc) return showToast('Fill details correctly');
            if(amt > window.userData.balance) return showToast('Insufficient funds');

            window.userData.balance -= amt;
            
            const req = {
                id: Date.now(),
                amount: amt,
                details: { name, bank, acc, ifsc, mobile },
                status: 'pending',
                date: new Date().toLocaleDateString()
            };

            if(!window.userData.withdrawRequests) window.userData.withdrawRequests = [];
            window.userData.withdrawRequests.push(req);
            saveToDB(window.userData);
            closeModals();
            showToast('Withdrawal request submitted! Balance deducted.');
            document.querySelectorAll('#withdrawModal input').forEach(i => i.value = '');
        };

        // === HELPERS ===
        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
        window.copyLink = () => {
            navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(()=>showToast('Link copied!'));
        }
        window.nativeShare = () => {
            if (navigator.share) navigator.share({url: document.getElementById('refLink').innerText});
            else copyLink();
        }
        window.shareWhatsapp = () => {
            window.open(`https://wa.me/?text=Join here: ${document.getElementById('refLink').innerText}`, '_blank');
        }

        // === LEGAL MODAL LOGIC ===
        window.openLegal = () => {
            document.getElementById('legalModal').style.display = 'flex';
            showLegal('terms'); // Default to terms
        };

        window.showLegal = (type) => {
            const container = document.getElementById('legalContent');
            const btnTerms = document.getElementById('btnTerms');
            const btnPrivacy = document.getElementById('btnPrivacy');

            if (type === 'terms') {
                container.innerHTML = legalDocs.terms;
                btnTerms.classList.add('active');
                btnPrivacy.classList.remove('active');
            } else {
                container.innerHTML = legalDocs.privacy;
                btnTerms.classList.remove('active');
                btnPrivacy.classList.add('active');
            }
        };

        // === RENDER INVITED LIST ===
        function renderInvitedList(data) {
            const listContainer = document.getElementById('invitedList');
            const titleContainer = document.getElementById('inviteListTitle');
            
            listContainer.innerHTML = '';
            const list = data.invitedUsers || [];
            titleContainer.innerText = `Invited Routes (${list.length})`;

            if (list.length > 0) {
                list.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'invited-item';
                    div.innerHTML = `
                        <div class="invited-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div style="font-weight:600; font-size:0.9rem;">${user.name}</div>
                            <div style="font-size:0.75rem; color:#666;">${user.date}</div>
                        </div>
                        <div class="invited-status">Joined</div>
                    `;
                    listContainer.appendChild(div);
                });
            } else {
                listContainer.innerHTML = '<p style="text-align:center; color:#999; font-size:0.9rem; padding:10px;">No invites yet</p>';
            }
        }

        // === LEADERBOARD LOGIC ===
        window.switchLeaderboard = (type) => {
            leaderboardType = type;
            document.getElementById('btnDaily').className = type === 'daily' ? 'lb-btn active' : 'lb-btn';
            document.getElementById('btnMonthly').className = type === 'monthly' ? 'lb-btn active' : 'lb-btn';
            loadLeaderboard();
        };

        async function loadLeaderboard() {
            const listContainer = document.getElementById('leaderboardList');
            listContainer.innerHTML = '';
            if(!window.currentUser) return;
            
            const q = query(collection(db, "users"));
            const querySnapshot = await getDocs(q);
            const allUsers = querySnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            
            const rankedUsers = allUsers.map(u => ({
                name: u.name,
                earnings: (leaderboardType === 'daily' ? (u.todayEarnings || 0) : (u.monthEarnings || 0)),
                isMe: u.uid === window.currentUser.uid
            })).sort((a, b) => b.earnings - a.earnings);

            if (rankedUsers.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; padding:20px;">No data available</p>';
                return;
            }

            rankedUsers.forEach((user, index) => {
                const item = document.createElement('div');
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                item.className = `lb-item ${user.isMe ? 'me' : ''}`;
                item.innerHTML = `
                    <div class="lb-rank ${rankClass}">${rank}</div>
                    <div class="lb-avatar">${user.name.charAt(0).toUpperCase()}</div>
                    <div class="lb-info">
                        <div class="lb-name">${user.name} ${user.isMe ? '(You)' : ''}</div>
                        <div class="lb-earning">Earned: ‚Çπ${user.earnings.toFixed(2)}</div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>